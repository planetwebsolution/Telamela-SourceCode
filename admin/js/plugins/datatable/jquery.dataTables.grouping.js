(function($){"use strict";$.fn.rowGrouping=function(options){function _fnOnGrouped(){}function _fnOnGroupCreated(oGroup,sGroup,iLevel){}function _fnOnGroupCompleted(oGroup,sGroup,iLevel){}function _getMonthName(iMonth){var asMonths=["January","February","March","April","May","June","July","August","September","October","November","December"];return asMonths[iMonth-1]}var defaults={iGroupingColumnIndex:0,sGroupingColumnSortDirection:"",iGroupingOrderByColumnIndex:-1,sGroupingClass:"group",sGroupItemClass:"group-item",bHideGroupingColumn:true,bHideGroupingOrderByColumn:true,sGroupBy:"name",sGroupLabelPrefix:"",fnGroupLabelFormat:function(label){return label},bExpandableGrouping:false,bExpandSingleGroup:false,iExpandGroupOffset:100,asExpandedGroups:null,sDateFormat:"dd/MM/yyyy",sEmptyGroupLabel:"-",bSetGroupingClassOnTR:false,iGroupingColumnIndex2:-1,sGroupingColumnSortDirection2:"",iGroupingOrderByColumnIndex2:-1,sGroupingClass2:"subgroup",sGroupItemClass2:"subgroup-item",bHideGroupingColumn2:true,bHideGroupingOrderByColumn2:true,sGroupBy2:"name",sGroupLabelPrefix2:"",fnGroupLabelFormat2:function(label){return label},bExpandableGrouping2:false,fnOnGrouped:_fnOnGrouped,fnOnGroupCreated:_fnOnGroupCreated,fnOnGroupCompleted:_fnOnGroupCompleted,oHideEffect:null,oShowEffect:null,bUseFilteringForGrouping:false};return this.each(function(index,elem){var oTable=$(elem).dataTable();var aoGroups=new Array();$(this).dataTableExt.aoGroups=aoGroups;function fnCreateGroupRow(sGroupCleaned,sGroup,iColspan){var nGroup=document.createElement('tr');var nCell=document.createElement('td');nGroup.id="group-id-"+oTable.attr("id")+"_"+sGroupCleaned;var oGroup={id:nGroup.id,key:sGroupCleaned,text:sGroup,level:0,groupItemClass:".group-item-"+sGroupCleaned,dataGroup:sGroupCleaned,aoSubgroups:new Array()};if(properties.bSetGroupingClassOnTR){nGroup.className=properties.sGroupingClass+" "+sGroupCleaned}else{nCell.className=properties.sGroupingClass+" "+sGroupCleaned}nCell.colSpan=iColspan;nCell.innerHTML=properties.sGroupLabelPrefix+properties.fnGroupLabelFormat(sGroup==""?properties.sEmptyGroupLabel:sGroup,oGroup);if(properties.bExpandableGrouping){if(!_fnIsGroupCollapsed(sGroupCleaned)){nCell.className+=" expanded-group";oGroup.state="expanded"}else{nCell.className+=" collapsed-group";oGroup.state="collapsed"}nCell.className+=" group-item-expander";$(nCell).attr('data-group',oGroup.dataGroup);$(nCell).attr("data-group-level",oGroup.level);$(nCell).click(_fnOnGroupClick)}nGroup.appendChild(nCell);aoGroups[sGroupCleaned]=oGroup;oGroup.nGroup=nGroup;properties.fnOnGroupCreated(oGroup,sGroupCleaned,1);return oGroup}function _fnCreateGroup2Row(sGroup2,sGroupLabel,iColspan,oParentGroup){var nGroup2=document.createElement('tr');nGroup2.id=oParentGroup.id+"_"+sGroup2;var nCell2=document.createElement('td');var dataGroup=oParentGroup.dataGroup+'_'+sGroup2;var oGroup={id:nGroup2.id,key:sGroup2,text:sGroupLabel,level:oParentGroup.level+1,groupItemClass:".group-item-"+dataGroup,dataGroup:dataGroup,aoSubgroups:new Array()};if(properties.bSetGroupingClassOnTR){nGroup2.className=properties.sGroupingClass2+" "+sGroup2}else{nCell2.className=properties.sGroupingClass2+" "+sGroup2}nCell2.colSpan=iColspan;nCell2.innerHTML=properties.sGroupLabelPrefix2+properties.fnGroupLabelFormat2(sGroupLabel==""?properties.sEmptyGroupLabel:sGroupLabel,oGroup);if(properties.bExpandableGrouping){nGroup2.className+=" group-item-"+oParentGroup.dataGroup}if(properties.bExpandableGrouping&&properties.bExpandableGrouping2){if(!_fnIsGroupCollapsed(oGroup.dataGroup)){nCell2.className+=" expanded-group";oGroup.state="expanded"}else{nCell2.className+=" collapsed-group";oGroup.state="collapsed"}nCell2.className+=" group-item-expander";$(nCell2).attr('data-group',oGroup.dataGroup);$(nCell2).attr("data-group-level",oGroup.level);$(nCell2).click(_fnOnGroupClick)}nGroup2.appendChild(nCell2);oParentGroup.aoSubgroups[oGroup.dataGroup]=oGroup;aoGroups[oGroup.dataGroup]=oGroup;oGroup.nGroup=nGroup2;properties.fnOnGroupCreated(oGroup,sGroup2,2);return oGroup}function _fnIsGroupCollapsed(sGroup){if(aoGroups[sGroup]!=null)return(aoGroups[sGroup].state=="collapsed");else if(sGroup.indexOf("_")>-1)true;else if(bInitialGrouping&&(asExpandedGroups==null||asExpandedGroups.length==0))return false;else return($.inArray(sGroup,asExpandedGroups)==-1)}function _fnGetYear(x){if(x.length<(iYearIndex+iYearLength))return x;else return x.substr(iYearIndex,iYearLength)}function _fnGetGroupByName(x){return x}function _fnGetGroupByLetter(x){return x.substr(0,1)}function _fnGetGroupByYear(x){return _fnGetYear(x)}function _fnGetGroupByYearMonth(x){return x.substr(iYearIndex,iYearLength)+' '+_getMonthName(x.substr(iMonthIndex,iMonthLength))}function _fnGetCleanedGroup(sGroup){if(sGroup==="")return"-";return sGroup.toLowerCase().replace(/[^a-zA-Z0-9\u0080-\uFFFF]+/g,"-")}function _rowGroupingRowFilter(oSettings,aData,iDataIndex){if(oSettings.nTable.id!==oTable[0].id)return true;var sColData=aData[properties.iGroupingColumnIndex];if(typeof sColData==="undefined")sColData=aData[oSettings.aoColumns[properties.iGroupingColumnIndex].mDataProp];if(_fnIsGroupCollapsed(_fnGetCleanedGroup(sColData))){if(oTable.fnIsOpen(oTable.fnGetNodes(iDataIndex))){if(properties.fnOnRowClosed!=null){properties.fnOnRowClosed(this)}oTable.fnClose(oTable.fnGetNodes(iDataIndex))}return false};return true}function fnExpandGroup(sGroup){aoGroups[sGroup].state="expanded";$("td[data-group^='"+sGroup+"']").removeClass("collapsed-group");$("td[data-group^='"+sGroup+"']").addClass("expanded-group");if(properties.bUseFilteringForGrouping){oTable.fnDraw();return}if(jQuery.inArray(sGroup,asExpandedGroups)==-1)asExpandedGroups.push(sGroup);if(properties.oHideEffect!=null)$(".group-item-"+sGroup,oTable)[properties.oShowEffect.method](properties.oShowEffect.duration,properties.oShowEffect.easing,function(){});else $(".group-item-"+sGroup,oTable).show()}function fnCollapseGroup(sGroup){aoGroups[sGroup].state="collapsed";$("td[data-group^='"+sGroup+"']").removeClass("expanded-group");$("td[data-group^='"+sGroup+"']").addClass("collapsed-group");if(properties.bUseFilteringForGrouping){oTable.fnDraw();return}$('.group-item-'+sGroup).each(function(){if(oTable.fnIsOpen(this)){if(properties.fnOnRowClosed!=null){properties.fnOnRowClosed(this)}oTable.fnClose(this)}});if(properties.oHideEffect!=null)$(".group-item-"+sGroup,oTable)[properties.oHideEffect.method](properties.oHideEffect.duration,properties.oHideEffect.easing,function(){});else $(".group-item-"+sGroup,oTable).hide()}function _fnOnGroupClick(e){var sGroup=$(this).attr("data-group");var iGroupLevel=$(this).attr("data-group-level");var bIsExpanded=!_fnIsGroupCollapsed(sGroup);if(properties.bExpandSingleGroup){if(!bIsExpanded){var sCurrentGroup=$("td.expanded-group").attr("data-group");fnCollapseGroup(sCurrentGroup);fnExpandGroup(sGroup);if(properties.iExpandGroupOffset!=-1){var position=$("#group-id-"+oTable.attr("id")+"_"+sGroup).offset().top-properties.iExpandGroupOffset;window.scroll(0,position)}else{var position=oTable.offset().top;window.scroll(0,position)}}}else{if(bIsExpanded){fnCollapseGroup(sGroup)}else{fnExpandGroup(sGroup)}}e.preventDefault()};function _fnDrawCallBackWithGrouping(oSettings){if(oTable.fnSettings().oFeatures.bServerSide)bInitialGrouping=true;var bUseSecondaryGrouping=false;if(properties.iGroupingColumnIndex2!=-1)bUseSecondaryGrouping=true;if(oSettings.aiDisplayMaster.length==0){return}var nTrs=$('tbody tr',oTable);var iColspan=0;for(var iColIndex=0;iColIndex<oSettings.aoColumns.length;iColIndex++){if(oSettings.aoColumns[iColIndex].bVisible)iColspan+=1}var sLastGroup=null;var sLastGroup2=null;if(oSettings.aiDisplay.length>0){for(var i=0;i<nTrs.length;i++){var iDisplayIndex=oSettings._iDisplayStart+i;if(oTable.fnSettings().oFeatures.bServerSide)iDisplayIndex=i;var sGroupData="";var sGroup=null;var sGroupData2="";var sGroup2=null;sGroupData=this.fnGetData(nTrs[i],properties.iGroupingColumnIndex);var sGroup=sGroupData;if(properties.sGroupBy!="year")sGroup=fnGetGroup(sGroupData);if(bUseSecondaryGrouping){sGroupData2=oSettings.aoData[oSettings.aiDisplay[iDisplayIndex]]._aData[properties.iGroupingColumnIndex2];if(sGroupData2==undefined)sGroupData2=oSettings.aoData[oSettings.aiDisplay[iDisplayIndex]]._aData[oSettings.aoColumns[properties.iGroupingColumnIndex2].mDataProp];if(properties.sGroupBy2!="year")sGroup2=fnGetGroup(sGroupData2)}if(sLastGroup==null||_fnGetCleanedGroup(sGroup)!=_fnGetCleanedGroup(sLastGroup)){var sGroupCleaned=_fnGetCleanedGroup(sGroup);if(sLastGroup!=null){properties.fnOnGroupCompleted(aoGroups[_fnGetCleanedGroup(sLastGroup)])}if(properties.bAddAllGroupsAsExpanded&&jQuery.inArray(sGroupCleaned,asExpandedGroups)==-1)asExpandedGroups.push(sGroupCleaned);var oGroup=fnCreateGroupRow(sGroupCleaned,sGroup,iColspan);var nGroup=oGroup.nGroup;if(nTrs[i].parentNode!=null)nTrs[i].parentNode.insertBefore(nGroup,nTrs[i]);else $(nTrs[i]).before(nGroup);sLastGroup=sGroup;sLastGroup2=null}$(nTrs[i]).attr("data-group",aoGroups[sGroupCleaned].dataGroup);$(nTrs[i]).addClass(properties.sGroupItemClass);$(nTrs[i]).addClass("group-item-"+sGroupCleaned);if(properties.bExpandableGrouping){if(_fnIsGroupCollapsed(sGroupCleaned)&&!properties.bUseFilteringForGrouping){$(nTrs[i]).hide()}}if(bUseSecondaryGrouping){if(sLastGroup2==null||_fnGetCleanedGroup(sGroup2)!=_fnGetCleanedGroup(sLastGroup2)){var sGroup2Id=_fnGetCleanedGroup(sGroup)+'-'+_fnGetCleanedGroup(sGroup2);var oGroup2=_fnCreateGroup2Row(sGroup2Id,sGroup2,iColspan,aoGroups[sGroupCleaned])var nGroup2=oGroup2.nGroup;nTrs[i].parentNode.insertBefore(nGroup2,nTrs[i]);sLastGroup2=sGroup2}$(nTrs[i]).attr("data-group",oGroup2.dataGroup).addClass(properties.sGroupItemClass2).addClass("group-item-"+oGroup2.dataGroup)}}};if(sLastGroup!=null){properties.fnOnGroupCompleted(aoGroups[_fnGetCleanedGroup(sLastGroup)])}properties.fnOnGrouped(aoGroups);bInitialGrouping=false};var iYearIndex=6;var iYearLength=4;var asExpandedGroups=new Array();var bInitialGrouping=true;var properties=$.extend(defaults,options);if(properties.iGroupingOrderByColumnIndex==-1){properties.bCustomColumnOrdering=false;properties.iGroupingOrderByColumnIndex=properties.iGroupingColumnIndex}else{properties.bCustomColumnOrdering=true}if(properties.sGroupingColumnSortDirection==""){if(properties.sGroupBy=="year")properties.sGroupingColumnSortDirection="desc";else properties.sGroupingColumnSortDirection="asc"}if(properties.iGroupingOrderByColumnIndex2==-1){properties.bCustomColumnOrdering2=false;properties.iGroupingOrderByColumnIndex2=properties.iGroupingColumnIndex2}else{properties.bCustomColumnOrdering2=true}if(properties.sGroupingColumnSortDirection2==""){if(properties.sGroupBy2=="year")properties.sGroupingColumnSortDirection2="desc";else properties.sGroupingColumnSortDirection2="asc"}iYearIndex=properties.sDateFormat.toLowerCase().indexOf('yy');iYearLength=properties.sDateFormat.toLowerCase().lastIndexOf('y')-properties.sDateFormat.toLowerCase().indexOf('y')+1;var iMonthIndex=properties.sDateFormat.toLowerCase().indexOf('mm');var iMonthLength=properties.sDateFormat.toLowerCase().lastIndexOf('m')-properties.sDateFormat.toLowerCase().indexOf('m')+1;var fnGetGroup=_fnGetGroupByName;switch(properties.sGroupBy){case"letter":fnGetGroup=_fnGetGroupByLetter;break;case"year":fnGetGroup=_fnGetGroupByYear;break;case"month":fnGetGroup=_fnGetGroupByYearMonth;break;default:fnGetGroup=_fnGetGroupByName;break}if(properties.asExpandedGroups!=null){if(properties.asExpandedGroups=="NONE"){properties.asExpandedGroups=[];asExpandedGroups=properties.asExpandedGroups;bInitialGrouping=false}else if(properties.asExpandedGroups=="ALL"){properties.bAddAllGroupsAsExpanded=true}else if(properties.asExpandedGroups.constructor==String){var currentGroup=properties.asExpandedGroups;properties.asExpandedGroups=new Array();properties.asExpandedGroups.push(_fnGetCleanedGroup(currentGroup));asExpandedGroups=properties.asExpandedGroups;bInitialGrouping=false}else if(properties.asExpandedGroups.constructor==Array){for(var i=0;i<properties.asExpandedGroups.length;i++){asExpandedGroups.push(_fnGetCleanedGroup(properties.asExpandedGroups[i]));if(properties.bExpandSingleGroup)break}bInitialGrouping=false}}else{properties.asExpandedGroups=new Array();properties.bAddAllGroupsAsExpanded=true}if(properties.bExpandSingleGroup){var nTrs=$('tbody tr',oTable);var sGroupData=oTable.fnGetData(nTrs[0],properties.iGroupingColumnIndex);var sGroup=sGroupData;if(properties.sGroupBy!="year")sGroup=fnGetGroup(sGroupData);var sGroupCleaned=_fnGetCleanedGroup(sGroup);properties.asExpandedGroups=new Array();properties.asExpandedGroups.push(sGroupCleaned)}oTable.fnSetColumnVis(properties.iGroupingColumnIndex,!properties.bHideGroupingColumn);if(properties.bCustomColumnOrdering){oTable.fnSetColumnVis(properties.iGroupingOrderByColumnIndex,!properties.bHideGroupingOrderByColumn)}if(properties.iGroupingColumnIndex2!=-1){oTable.fnSetColumnVis(properties.iGroupingColumnIndex2,!properties.bHideGroupingColumn2)}if(properties.bCustomColumnOrdering2){oTable.fnSetColumnVis(properties.iGroupingOrderByColumnIndex2,!properties.bHideGroupingOrderByColumn2)}oTable.fnSettings().aoDrawCallback.push({"fn":_fnDrawCallBackWithGrouping,"sName":"fnRowGrouping"});var aaSortingFixed=new Array();aaSortingFixed.push([properties.iGroupingOrderByColumnIndex,properties.sGroupingColumnSortDirection]);if(properties.iGroupingColumnIndex2!=-1){aaSortingFixed.push([properties.iGroupingOrderByColumnIndex2,properties.sGroupingColumnSortDirection2])}oTable.fnSettings().aaSortingFixed=aaSortingFixed;switch(properties.sGroupBy){case"name":break;case"letter":oTable.fnSettings().aoColumns[properties.iGroupingOrderByColumnIndex].sSortDataType="rg-letter";$.fn.dataTableExt.afnSortData['rg-letter']=function(oSettings,iColumn){var aData=[];$('td:eq('+iColumn+')',oSettings.oApi._fnGetTrNodes(oSettings)).each(function(){aData.push(_fnGetGroupByLetter(this.innerHTML))});return aData}break;case"year":oTable.fnSettings().aoColumns[properties.iGroupingOrderByColumnIndex].sSortDataType="rg-date";$.fn.dataTableExt.afnSortData['rg-date']=function(oSettings,iColumn){var aData=[];var nTrs=oSettings.oApi._fnGetTrNodes(oSettings);for(i=0;i<nTrs.length;i++){aData.push(_fnGetYear(oTable.fnGetData(nTrs[i],iColumn)))}return aData}break;default:break}if(properties.bUseFilteringForGrouping)$.fn.dataTableExt.afnFiltering.push(_rowGroupingRowFilter);oTable.fnDraw()})}})(jQuery);
